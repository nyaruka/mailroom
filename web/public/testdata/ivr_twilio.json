[
    {
        "label": "handle start on wired call",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=start&call=01969b47-190b-76f8-92a3-d648ab64bccb",
        "body": "",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Gather numDigits=\"1\" timeout=\"30\" action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather\">\n    <Say language=\"en-US\">Hello there. Please enter one or two.  This flow was triggered by Ann</Say>\n  </Gather>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather&amp;timeout=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "I",
                    "Call2": "W",
                    "Call3": "W"
                }
            },
            {
                "query": "SELECT last_seen_on FROM contacts_contact WHERE id = 10000",
                "returns": null
            },
            {
                "query": "SELECT text, msg_type FROM msgs_msg WHERE contact_id = 10000",
                "columns": {
                    "text": "Hello there. Please enter one or two.  This flow was triggered by Ann",
                    "msg_type": "V"
                }
            }
        ],
        "expected_history": [
            {
                "PK": "con#a393abc0-283d-4c9b-a1b3-641a035c34bf",
                "SK": "evt#01969b47-0d53-76f8-bd38-d266ec8d3716",
                "OrgID": 1,
                "Data": {
                    "call": {
                        "channel": {
                            "name": "Twilio",
                            "uuid": "74729f45-7f29-4868-9dc4-90e491e3c7d8"
                        },
                        "urn": "tel:+16055741111",
                        "uuid": "01969b47-190b-76f8-92a3-d648ab64bccb"
                    },
                    "created_on": "2025-05-04T12:30:48.123456789Z",
                    "type": "call_created"
                }
            },
            {
                "PK": "con#a393abc0-283d-4c9b-a1b3-641a035c34bf",
                "SK": "evt#01969b47-24c3-76f8-8f41-6b2d9f33d623",
                "OrgID": 1,
                "Data": {
                    "created_on": "2025-05-04T12:30:54.123456789Z",
                    "flow": {
                        "name": "IVR Flow",
                        "revision": 1,
                        "uuid": "2f81d0ea-4d75-4843-9371-3f7465311cce"
                    },
                    "parent_uuid": "8bc73097-ac57-47fb-82e5-184f8ec6dbef",
                    "run_uuid": "01969b47-20db-76f8-8228-9728778b6c98",
                    "type": "run_started"
                }
            }
        ]
    },
    {
        "label": "handle resume without digits we're waiting for",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b47-190b-76f8-92a3-d648ab64bccb",
        "body": "CallStatus=in-progress&timeout=true&wait_type=gather",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Gather numDigits=\"1\" timeout=\"30\" action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather\">\n    <Say language=\"en-US\">Sorry, that is not one or two, try again.</Say>\n  </Gather>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather&amp;timeout=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "I",
                    "Call2": "W",
                    "Call3": "W"
                }
            },
            {
                "query": "SELECT last_seen_on::text FROM contacts_contact WHERE id = 10000",
                "returns": "2025-05-04 12:31:13.123457+00"
            }
        ]
    },
    {
        "label": "handle resume with digits we're waiting for",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b47-190b-76f8-92a3-d648ab64bccb",
        "body": "CallStatus=in-progress&Digits=1&wait_type=gather",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Gather timeout=\"30\" action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather\">\n    <Say language=\"en-US\">Great! You said One. Ok, now enter a number 1 to 100 then press pound.</Say>\n  </Gather>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather&amp;timeout=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "I",
                    "Call2": "W",
                    "Call3": "W"
                }
            },
            {
                "query": "SELECT last_seen_on::text FROM contacts_contact WHERE id = 10000",
                "returns": "2025-05-04 12:31:38.123457+00"
            }
        ]
    },
    {
        "label": "handle resume with digits that are out of range specified in flow",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b47-190b-76f8-92a3-d648ab64bccb",
        "body": "CallStatus=in-progress&Digits=101&wait_type=gather",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Gather timeout=\"30\" action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather\">\n    <Say language=\"en-US\">Sorry, that&#39;s too big. Enter a number 1 to 100 then press pound.</Say>\n  </Gather>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=gather&amp;timeout=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "I",
                    "Call2": "W",
                    "Call3": "W"
                }
            }
        ]
    },
    {
        "label": "handle resume with digits that are in range specified in flow",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b47-190b-76f8-92a3-d648ab64bccb",
        "body": "CallStatus=in-progress&Digits=56&wait_type=gather",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Say language=\"en-US\">You picked the number 56, excellent choice. Ok now tell me briefly why you are happy today.</Say>\n  <Record action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=record\" maxLength=\"600\"></Record>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=record&amp;empty=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "I",
                    "Call2": "W",
                    "Call3": "W"
                }
            }
        ]
    },
    {
        "label": "handle resume with missing recording that should start a call forward",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b47-190b-76f8-92a3-d648ab64bccb",
        "body": "CallStatus=in-progress&wait_type=record",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Say language=\"en-US\">You said</Say>\n  <Say language=\"en-US\">I hope hearing that makes you feel better. Good day and good bye.</Say>\n  <Dial action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-190b-76f8-92a3-d648ab64bccb&amp;wait_type=dial\" timeout=\"60\" timeLimit=\"7200\">+12065551212</Dial>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "I",
                    "Call2": "W",
                    "Call3": "W"
                }
            }
        ]
    },
    {
        "label": "handle resume call forwarding result",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b47-190b-76f8-92a3-d648ab64bccb",
        "body": "CallStatus=in-progress&DialCallStatus=answered&wait_type=dial",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Say language=\"en-US\">Great, they answered.</Say>\n  <Hangup></Hangup>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "W",
                    "Call3": "W"
                }
            }
        ],
        "expected_history": [
            {
                "PK": "con#a393abc0-283d-4c9b-a1b3-641a035c34bf",
                "SK": "evt#01969b49-7683-76f8-802a-9fffea2a27fa",
                "OrgID": 1,
                "Data": {
                    "created_on": "2025-05-04T12:33:26.123456789Z",
                    "flow": {
                        "name": "IVR Flow",
                        "revision": 1,
                        "uuid": "2f81d0ea-4d75-4843-9371-3f7465311cce"
                    },
                    "run_uuid": "01969b47-20db-76f8-8228-9728778b6c98",
                    "status": "completed",
                    "type": "run_ended"
                }
            }
        ]
    },
    {
        "label": "status update that call 1 is complete",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/status",
        "body": "CallDuration=50&CallSid=Call1&CallStatus=completed",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response><!--status updated: D--></Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "W",
                    "Call3": "W"
                }
            }
        ]
    },
    {
        "label": "start call 2",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=start&call=01969b47-2c93-76f8-8f41-6b2d9f33d623",
        "body": "",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Gather numDigits=\"1\" timeout=\"30\" action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-2c93-76f8-8f41-6b2d9f33d623&amp;wait_type=gather\">\n    <Say language=\"en-US\">Hello there. Please enter one or two.  This flow was triggered by Ann</Say>\n  </Gather>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b47-2c93-76f8-8f41-6b2d9f33d623&amp;wait_type=gather&amp;timeout=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "I",
                    "Call3": "W"
                }
            }
        ],
        "expected_history": [
            {
                "PK": "con#b699a406-7e44-49be-9f01-1a82893e8a10",
                "SK": "evt#01969b49-9d93-76f8-b4c4-260cfebfde0b",
                "OrgID": 1,
                "Data": {
                    "call": {
                        "channel": {
                            "name": "Twilio",
                            "uuid": "74729f45-7f29-4868-9dc4-90e491e3c7d8"
                        },
                        "urn": "tel:+16055742222",
                        "uuid": "01969b47-2c93-76f8-8f41-6b2d9f33d623"
                    },
                    "created_on": "2025-05-04T12:33:36.123456789Z",
                    "type": "call_created"
                }
            },
            {
                "PK": "con#b699a406-7e44-49be-9f01-1a82893e8a10",
                "SK": "evt#01969b49-b503-76f8-8188-76dd971a6205",
                "OrgID": 1,
                "Data": {
                    "created_on": "2025-05-04T12:33:42.123456789Z",
                    "flow": {
                        "name": "IVR Flow",
                        "revision": 1,
                        "uuid": "2f81d0ea-4d75-4843-9371-3f7465311cce"
                    },
                    "parent_uuid": "8bc73097-ac57-47fb-82e5-184f8ec6dbef",
                    "run_uuid": "01969b49-b11b-76f8-88a2-a356de113e34",
                    "type": "run_started"
                }
            }
        ]
    },
    {
        "label": "resume with status that says call completed on Twilio side",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b47-2c93-76f8-8f41-6b2d9f33d623",
        "body": "CallStatus=completed&Digits=56&wait_type=gather",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response><!--call completed--><Say>An error has occurred, please try again later.</Say><Hangup></Hangup></Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "D",
                    "Call3": "W"
                }
            }
        ]
    },
    {
        "label": "call 3 started with answered_by telling us it's a machine",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=start&call=01969b47-401b-76f8-ba00-bd7f0d08e671",
        "body": "AnsweredBy=machine_start&CallStatus=in-progress",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response><!--status updated: E, next_attempt: 2025-05-04 13:34:24.123456789 +0000 UTC--><Say>An error has occurred, please try again later.</Say><Hangup></Hangup></Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "D",
                    "Call3": "E"
                }
            }
        ]
    },
    {
        "label": "then Twilio will call the status callback to say that we're done but don't overwrite the error status",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/status",
        "body": "CallDuration=50&CallSid=Call3&CallStatus=completed",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response><!--status D ignored, already errored--></Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "D",
                    "Call3": "E"
                }
            }
        ]
    },
    {
        "label": "now we get an incoming call from Ann which should match our trigger (because she is in Doctors group)",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/incoming",
        "body": "CallSid=Call4&CallStatus=ringing&Caller=%2B16055741111",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Gather numDigits=\"1\" timeout=\"30\" action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b4a-7853-76f8-9029-066bfcb36cf8&amp;wait_type=gather\">\n    <Say language=\"en-US\">Hello there. Please enter one or two.</Say>\n  </Gather>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b4a-7853-76f8-9029-066bfcb36cf8&amp;wait_type=gather&amp;timeout=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "D",
                    "Call3": "E",
                    "Call4": "I"
                }
            }
        ],
        "expected_history": [
            {
                "PK": "con#a393abc0-283d-4c9b-a1b3-641a035c34bf",
                "SK": "evt#01969b4a-7c3b-76f8-ba1b-6cc3bea197e4",
                "OrgID": 1,
                "Data": {
                    "call": {
                        "channel": {
                            "name": "Twilio",
                            "uuid": "74729f45-7f29-4868-9dc4-90e491e3c7d8"
                        },
                        "urn": "tel:+16055741111?channel=74729f45-7f29-4868-9dc4-90e491e3c7d8\u0026id=10000",
                        "uuid": "01969b4a-7853-76f8-9029-066bfcb36cf8"
                    },
                    "created_on": "2025-05-04T12:34:33.123456789Z",
                    "type": "call_received"
                }
            },
            {
                "PK": "con#a393abc0-283d-4c9b-a1b3-641a035c34bf",
                "SK": "evt#01969b4a-9793-76f8-9c96-61ebc05df996",
                "OrgID": 1,
                "Data": {
                    "created_on": "2025-05-04T12:34:40.123456789Z",
                    "flow": {
                        "name": "IVR Flow",
                        "revision": 1,
                        "uuid": "2f81d0ea-4d75-4843-9371-3f7465311cce"
                    },
                    "run_uuid": "01969b4a-93ab-76f8-9676-22cd6062f002",
                    "type": "run_started"
                }
            }
        ]
    },
    {
        "label": "handle resume with digits we're waiting for",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&call=01969b4a-7853-76f8-9029-066bfcb36cf8",
        "body": "CallStatus=in-progress&Digits=2&wait_type=gather",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n  <Gather timeout=\"30\" action=\"https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b4a-7853-76f8-9029-066bfcb36cf8&amp;wait_type=gather\">\n    <Say language=\"en-US\">Great! You said Two. Ok, now enter a number 1 to 100 then press pound.</Say>\n  </Gather>\n  <Redirect>https://localhost:8091/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/handle?action=resume&amp;call=01969b4a-7853-76f8-9029-066bfcb36cf8&amp;wait_type=gather&amp;timeout=true</Redirect>\n</Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "D",
                    "Call3": "E",
                    "Call4": "I"
                }
            }
        ]
    },
    {
        "label": "now we get an incoming call from Bob which won't match our trigger (because he is not in Doctors group)",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/incoming",
        "body": "CallSid=Call5&CallStatus=ringing&Caller=%2B16055742222",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response><!--missed call handled--></Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "D",
                    "Call3": "E",
                    "Call4": "I",
                    "Call5": "I"
                }
            }
        ],
        "expected_history": [
            {
                "PK": "con#b699a406-7e44-49be-9f01-1a82893e8a10",
                "SK": "evt#01969b4b-4373-76f8-82ae-81542083c6c6",
                "OrgID": 1,
                "Data": {
                    "call": {
                        "channel": {
                            "name": "Twilio",
                            "uuid": "74729f45-7f29-4868-9dc4-90e491e3c7d8"
                        },
                        "urn": "tel:+16055742222?channel=74729f45-7f29-4868-9dc4-90e491e3c7d8\u0026id=10001",
                        "uuid": "01969b4b-3f8b-76f8-9c41-cf3f881022fb"
                    },
                    "created_on": "2025-05-04T12:35:24.123456789Z",
                    "type": "call_received"
                }
            }
        ]
    },
    {
        "label": "status update that call 5 has failed",
        "method": "POST",
        "path": "/mr/ivr/c/74729f45-7f29-4868-9dc4-90e491e3c7d8/status",
        "body": "CallDuration=50&CallSid=Call5&CallStatus=failed",
        "status": 200,
        "response": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response><!--no flow start found, status updated: F--></Response>",
        "db_assertions": [
            {
                "query": "SELECT external_id, status FROM ivr_call",
                "map": {
                    "Call1": "D",
                    "Call2": "D",
                    "Call3": "E",
                    "Call4": "I",
                    "Call5": "F"
                }
            }
        ]
    }
]